<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scripts.client &mdash; assignment_2_2023 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=359c27e9"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            assignment_2_2023
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">assignment_2_2023</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">scripts.client</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scripts.client</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: client</span>

<span class="sd">   :platform: Unix</span>
<span class="sd">   :synopsis: Python module that implements a client that sends a goal</span>
<span class="sd">              to the server and cancels it if the user wants to.</span>
<span class="sd">   :description: In this module, a ROS node is implemented that sends a goal to the server and cancels it if the user wants to.</span>
<span class="sd">                 The goal is set by the user by keyboard in a new terminal and it is sent to the server.</span>
<span class="sd">                 The user can cancel the goal by typing **y** in the terminal where the client is running.</span>
<span class="sd">                 The client also receives the current position and velocity of the robot and publishes them. It is able to cancel the goal only if the goal has not been reached yet; this is known thanks to the topics `/reaching_goal/feedback` and `/reaching_goal/result`.</span>

<span class="sd">                 Publisher:</span>
<span class="sd">                    - `/info_pos_vel`</span>

<span class="sd">                 Subscribers:</span>
<span class="sd">                    - `/odom`</span>
<span class="sd">                    - `/reaching_goal/feedback`</span>
<span class="sd">                    - `/reaching_goal/result`</span>

<span class="sd">.. moduleauthor:: Daniele Rialdi daniele.rialdi@gmail.com</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">nav_msgs.msg</span> <span class="kn">import</span> <span class="n">Odometry</span>
<span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">import</span> <span class="nn">actionlib.msg</span>
<span class="kn">import</span> <span class="nn">actionlib_msgs.msg</span>
<span class="kn">import</span> <span class="nn">assignment_2_2023.msg</span>
<span class="kn">from</span> <span class="nn">assignment_2_2023.msg</span> <span class="kn">import</span> <span class="n">PlanningAction</span>
<span class="kn">from</span> <span class="nn">assignment_2_2023.msg</span> <span class="kn">import</span> <span class="n">Info</span>



<div class="viewcode-block" id="on_feedback"><a class="viewcode-back" href="../../index.html#scripts.client.on_feedback">[docs]</a><span class="k">def</span> <span class="nf">on_feedback</span><span class="p">(</span><span class="n">action_feedback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback of the subscriber for feedback/status, that is used to check the status of the action server and to know if the robot is in the &#39;ACTIVE&#39; status or not.</span>
<span class="sd">    If so, the user is able to cancel the goal.</span>

<span class="sd">    :param action_feedback: message that contains the feedback of the action server</span>
<span class="sd">    :type action_feedback: assignment_2_2023.msg.PlanningActionFeedback</span>
<span class="sd">    :param canCancel: flag that is set to True if the robot is in the &#39;ACTIVE&#39; status</span>
<span class="sd">    :type canCancel: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">canCancel</span>
    
    <span class="c1"># We can preempt the robot only if the state machine is in the &quot;ACTIVE&quot; status</span>
    <span class="n">canCancel</span> <span class="o">=</span> <span class="p">(</span><span class="n">action_feedback</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">action_feedback</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span></div>
    
    <span class="c1">#rospy.loginfo(&quot;Feedback: pos_x = %f, pos_y = %f&quot;, action_feedback.feedback.actual_pose.position.x, action_feedback.feedback.actual_pose.position.y)</span>
    
    <span class="c1"># Log to see when the robot reaches the goal or when it gets preempted</span>
    <span class="c1">#  rospy.loginfo(&quot;Feedback Status %d&quot;, action_feedback.status.status)</span>
    <span class="c1"># if(action_feedback.status.status == action_feedback.status.SUCCEEDED):</span>
    <span class="c1">#     rospy.loginfo(&quot;Goal reached&quot;)</span>
    <span class="c1"># elif(action_feedback.status.status == action_feedback.status.PREEMPTING):</span>
    <span class="c1">#     rospy.loginfo(&quot;Goal preempted&quot;)</span>

        
<div class="viewcode-block" id="on_result"><a class="viewcode-back" href="../../index.html#scripts.client.on_result">[docs]</a><span class="k">def</span> <span class="nf">on_result</span><span class="p">(</span><span class="n">action_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback of the subscriber for result that is used to check the status of the action server and to know if the goal has been reached or not, simirarly to the feedback/status.</span>
<span class="sd">    The goal can be canceled only if the robot&#39;s state machine is not in the &quot;SUCCEEDED&quot; or in the &quot;PREEMPTED&quot; status.</span>

<span class="sd">    :param action_result: message that contains the result of the action server</span>
<span class="sd">    :type action_result: assignment_2_2023.msg.PlanningActionResult</span>
<span class="sd">    :param canCancel: flag that is set to True if the robot is in the &#39;ACTIVE&#39; status</span>
<span class="sd">    :type canCancel: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">canCancel</span>
    <span class="c1"># We can preempt the robot only if the state machine is not in the &quot;SUCCEEDED&quot; or in the &quot;PREEMPTED&quot; status</span>
    <span class="n">canCancel</span> <span class="o">=</span> <span class="ow">not</span><span class="p">(</span><span class="n">action_result</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">action_result</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SUCCEEDED</span> <span class="ow">or</span> <span class="n">action_result</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">action_result</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">PREEMPTED</span><span class="p">)</span></div>
    
    <span class="c1">#rospy.loginfo(&quot;Result Status %d&quot;, action_result.status.status)</span>


<div class="viewcode-block" id="on_odom"><a class="viewcode-back" href="../../index.html#scripts.client.on_odom">[docs]</a><span class="k">def</span> <span class="nf">on_odom</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback of the subscriber for Odometry data, that is used to get the current position and velocity of the robot and to publish them.</span>

<span class="sd">    :param msg: message that contains the Odometry data</span>
<span class="sd">    :type msg: nav_msgs.msg.Odometry</span>
<span class="sd">    :param pub_info: publisher that sends the info (x,y,vel_linear_x, vel_angular_z)</span>
<span class="sd">    :type pub_info: Info</span>
<span class="sd">    :param pos: current position of the robot</span>
<span class="sd">    :type pos: geometry_msgs.msg.Point</span>
<span class="sd">    :param vel_linear_x: current linear velocity of the robot</span>
<span class="sd">    :type vel_linear_x: float</span>
<span class="sd">    :param vel_angular_z: current angular velocity of the robot</span>
<span class="sd">    :type vel_angular_z: float</span>
<span class="sd">    :param info: message that contains the info (x,y,vel_linear_x, vel_angular_z)</span>
<span class="sd">    :type info: Info</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">pub_info</span>
    
    <span class="c1"># Get the current position</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span>
	
	<span class="c1"># Get the current velocity</span>
    <span class="n">vel_linear_x</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span>
    <span class="n">vel_angular_z</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>
    
    <span class="c1"># rospy.loginfo(&quot;Velocity: %f, %f&quot;, vel_linear_x, vel_angular_z)</span>
    
    <span class="c1"># Prepare and publish the info message</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">Info</span><span class="p">()</span>
    <span class="n">info</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span>
    <span class="n">info</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span>
    <span class="n">info</span><span class="o">.</span><span class="n">vel_linear_x</span> <span class="o">=</span> <span class="n">vel_linear_x</span>
    <span class="n">info</span><span class="o">.</span><span class="n">vel_angular_z</span> <span class="o">=</span> <span class="n">vel_angular_z</span>
    
    <span class="n">pub_info</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">info</span><span class="p">)</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../index.html#scripts.client.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function that initializes the node, the publishers and the subscribers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Declarations of global variables </span>
    <span class="k">global</span> <span class="n">pub_info</span><span class="p">,</span> <span class="n">canCancel</span>
    <span class="n">canCancel</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;client_node&#39;</span><span class="p">)</span>
    
    <span class="c1"># Declaring the publishers and subscribers</span>
    <span class="c1"># info_pub is a publisher that sends the info (x,y,vel_linear_x, vel_angular_z)</span>
    <span class="n">pub_info</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;/info_pos_vel&#39;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="n">queue_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># sub_odom is a subscriber that receives Odometry data</span>
    <span class="n">sub_odom</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;/odom&quot;</span><span class="p">,</span> <span class="n">Odometry</span><span class="p">,</span> <span class="n">on_odom</span><span class="p">)</span>
    
    <span class="c1"># Subscriber for feedback/status</span>
    <span class="n">sub_feedback</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;/reaching_goal/feedback&quot;</span><span class="p">,</span><span class="n">assignment_2_2023</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">PlanningActionFeedback</span><span class="p">,</span> <span class="n">on_feedback</span><span class="p">)</span>
    
    <span class="c1"># Subscriber for result</span>
    <span class="n">sub_result</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;/reaching_goal/result&quot;</span><span class="p">,</span><span class="n">assignment_2_2023</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">PlanningActionResult</span><span class="p">,</span> <span class="n">on_result</span><span class="p">)</span>


    <span class="c1"># Creating an instance of PlanningGoal</span>
    <span class="n">goal</span> <span class="o">=</span> <span class="n">assignment_2_2023</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">PlanningGoal</span><span class="p">()</span>
    
    <span class="c1"># Create the action client that connects to the action server /reaching_goal</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="s1">&#39;/reaching_goal&#39;</span><span class="p">,</span> <span class="n">PlanningAction</span><span class="p">)</span>
    
    <span class="c1"># Wait for the server to be started</span>
    <span class="n">client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
    
        <span class="c1"># Get the coordinates x and y from the user by keyboard checking that the input is valid</span>
        <span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">x_position</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Target X: &quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x_position</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x_position</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The input is not acceptable, please digit a number&quot;</span><span class="p">)</span>
        <span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">y_position</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Target Y: &quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">y_position</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_position</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The input is not acceptable, please digit a number&quot;</span><span class="p">)</span>
        <span class="c1"># Set and send the goal to the server</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_position</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y_position</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
        
        <span class="c1"># I have to wait a bit to ensure that the status is correctly set; if this is not done canCancel value </span>
        <span class="c1"># would not be updated. I have to wait that the feedback is provided at least once.</span>
        <span class="c1"># With time = 0.1 it works on my machine, but to be sure a time = 0.3 is set precautionsly </span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">canCancel</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter &#39;y&#39; if you want to cancel the goal just selected&quot;</span><span class="p">)</span>
            <span class="k">while</span><span class="p">(</span><span class="n">canCancel</span><span class="p">):</span>
                <span class="n">delete_char</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Cancel? &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span><span class="p">(</span><span class="n">delete_char</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">canCancel</span><span class="p">):</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">cancel_goal</span><span class="p">()</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The goal has already been reached&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The input is not valid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The goal has already been reached&quot;</span><span class="p">)</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span></div>
    


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
    
    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Daniele Rialdi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>